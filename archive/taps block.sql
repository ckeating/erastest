--SELECT *
--FROM dbo.CLARITY_SER AS cs
--WHERE prov_name LIKE '%tribble%'

----metric 12 --solid food given POD 1
--IF object_id('radb.dbo.TMP_met12diet') IS NOT NULL
--	DROP TABLE radb.dbo.TMP_met12diet;

SELECT 
       OP_PRNT.ORDER_PROC_ID AS PRNT_ORDER_PROC_ID
       , OP_PRNT.PROC_ID AS PRNT_PROC_ID
       , op_prnt.REASON_FOR_CANC_C AS PRNT_REASON_FOR_CANC_C
       , PRNT_Cancel.NAME AS ParentCancelReason
       , OP_CHLD.REASON_FOR_CANC_C AS CHLD_REASON_FOR_CANC_C
       , CHLD_Cancel.NAME AS ChildCancelReason
       , EAP.PROC_NAME AS PRNT_PROC_NAME
       , OP_PRNT.ORDER_STATUS_C AS PRNT_ORDER_STATUS_C
       , PRNT_OS.NAME AS PRNT_ORDER_STATUS
       , OP_PRNT.FUTURE_OR_STAND
       , OP_PRNT.INSTANTIATED_TIME
       , OP_PRNT.IS_PENDING_ORD_YN
       , OP_PRNT.STANDING_OCCURS
       , OP_PRNT.STAND_ORIG_OCCUR
       , OP_PRNT.ORDERING_DATE
       , OP_CHLD.ORDER_PROC_ID AS CHLD_ORDER_PROC_ID
       , OP_CHLD.PROC_ID AS CHLD_PROC_ID
       , CEAP.PROC_NAME AS CHLD_PROC_NAME
       , OP_CHLD.ORDER_STATUS_C AS CHLD_ORDER_STATUS_C
       , CHLD_LAB_STAT.NAME AS CHLD_LAB_STATUS
       , CHLD_OS.NAME AS CHLD_ORDER_STATUS
       , OP_CHLD.ORDER_TIME AS CHLD_ORDER_TIME 
       , OP_CHLD.PROC_START_TIME AS CHLD_START_TIME
       , OP_CHLD.RESULT_TIME AS CHLD_RESULT_TIME
       , CHLD_TURN_AROUND_TIME = CAST((DATEDIFF(MINUTE,  OP_CHLD.ORDER_TIME,  OP_CHLD.RESULT_TIME)) AS NUMERIC(20,2))
       --, CHLD_TURN_AROUND_TIME_FIRST_RESULT = CAST((DATEDIFF(MINUTE,  OP_CHLD.ORDER_TIME,  OSTAT.ROUTING_INST_TM)) AS NUMERIC(20,2))
--INTO radb.dbo.TMP_met12diet
FROM Clarity.dbo.ORDER_PROC AS OP_PRNT WITH(NOLOCK)
INNER JOIN Clarity.dbo.ORDER_INSTANTIATED AS OI WITH(NOLOCK)
     ON OP_PRNT.ORDER_PROC_ID = OI.ORDER_ID
INNER JOIN Clarity.dbo.ORDER_PROC AS OP_CHLD WITH(NOLOCK)
     ON OI.INSTNTD_ORDER_ID = OP_CHLD.ORDER_PROC_ID

INNER JOIN Clarity.dbo.PAT_ENC_HSP AS PEH WITH(NOLOCK) 
     ON PEH.PAT_ENC_CSN_ID = OP_PRNT.PAT_ENC_CSN_ID


LEFT JOIN Clarity.dbo.ZC_CONF_STAT AS CNF_STAT WITH(NOLOCK)
     ON PEH.ADMIT_CONF_STAT_C = CNF_STAT.ADMIT_CONF_STAT_C
LEFT JOIN Clarity.dbo.ZC_ORDER_STATUS AS CHLD_OS WITH(NOLOCK)
     ON OP_CHLD.ORDER_STATUS_C = CHLD_OS.ORDER_STATUS_C
LEFT JOIN Clarity.dbo.ZC_ORDER_STATUS AS PRNT_OS WITH(NOLOCK)
     ON OP_PRNT.ORDER_STATUS_C = PRNT_OS.ORDER_STATUS_C
LEFT JOIN Clarity.dbo.CLARITY_EAP AS EAP WITH(NOLOCK)
     ON OP_PRNT.PROC_ID = EAP.PROC_ID
LEFT JOIN Clarity.dbo.CLARITY_EAP AS CEAP WITH(NOLOCK)
     ON OP_CHLD.PROC_ID = CEAP.PROC_ID
LEFT JOIN Clarity.dbo.ZC_LAB_STATUS AS CHLD_LAB_STAT
     ON OP_CHLD.LAB_STATUS_C = CHLD_LAB_STAT.LAB_STATUS_C
LEFT JOIN clarity.dbo.ZC_REASON_FOR_CANC AS PRNT_Cancel
ON   PRNT_Cancel.REASON_FOR_CANC_C=OP_PRNT.REASON_FOR_CANC_C
LEFT JOIN clarity.dbo.ZC_REASON_FOR_CANC AS CHLD_Cancel
ON   CHLD_Cancel.REASON_FOR_CANC_C=OP_CHLD.REASON_FOR_CANC_C

WHERE (ISNULL(CHLD_OS.NAME, 'Active') <> 'Canceled'     
       OR  OP_CHLD.ORDER_STATUS_C=4 AND OP_CHLD.REASON_FOR_CANC_C=14)
       AND OP_PRNT.IS_PENDING_ORD_YN = 'N'
       AND OP_CHLD.IS_PENDING_ORD_YN = 'N'
       --AND OP_CHLD.proc_id IN (40485,40487,40493,40499,40501,40503,40505,40517,40519,40521,40533,40535,
							--  40537,40539,40541,40553,40555,40557,40565,40567,40573,40581,40585,40587,40593,63550,80119,
							--  80129,80135,80139,80143,80145,80151,80153,80163,80169,80175,89784,89794,89796,97659,99068,99111,
							--  99762,99763,99776,100111,101576,30415516326,111222555888,7988564596874)
--       AND OP_CHLD.PAT_ENC_CSN_ID IN (SELECT PAT_ENC_CSN_ID FROM radb.dbo.TMP_erasfact)
  --     AND (OP_CHLD.PROC_START_TIME>=f.pod1_2pm AND OP_CHLD.PROC_START_TIME<f.pod2_start) --order is placed between 2PM or greater POD 1
       AND OP_CHLD.AUTHRZING_PROV_ID='4895'
		AND peh.PAT_ENC_CSN_ID IN (	   SELECT  admissioncsn FROM radb.dbo.CRD_ERAS_Case_GHGI )
	   
	   ORDER BY OP_CHLD.PAT_ENC_CSN_ID,OP_CHLD.ORDERING_DATE;									 --and before Midnight POD 2



	   







SELECT  ev.HLV_ID
, sed.CUR_VALUE_SOURCE
,		op.PAT_ENC_CSN_ID
,		cc.ABBREVIATION AS ElementName
,		sed.ELEMENT_ID
,		ev.SMRTDTA_ELEM_VALUE
,       serauth.PROV_NAME AS AuthProvider
,       serrefer.prov_name AS ReferringProv
,		serperform.PROV_NAME AS PerformingProv
,		p.PAT_MRN_ID
,		p.PAT_NAME
,		op.ORDER_PROC_ID
,        op.ORDER_TIME
,		op.PROC_ID
--,op.*
,       op.PROC_CODE
,       op.DESCRIPTION
--,ev.*
--INTO RADB.dbo.ERAS_Smartform_onepatient
FROM         Clarity.dbo.Smrtdta_Elem_Data sed               
		   JOIN   (SELECT op.*
			       from CLarity.dbo.Order_Proc op			       
			       JOIN radb.dbo.CRD_ERAS_Case  f
				   ON f.anescsn=op.PAT_ENC_CSN_ID				   
					)op
        ON sed.record_id_numeric = op.order_proc_id
        JOIN Clarity.dbo.Smrtdta_Elem_Value ev ON sed.HLV_Id = ev.HLV_Id
        LEFT join clarity.dbo.CLARITY_CONCEPT AS cc ON sed.ELEMENT_ID = cc.CONCEPT_ID
        LEFT JOIN clarity.dbo.clarity_ser serauth ON serauth.PROV_ID = op.AUTHRZING_PROV_ID
        LEFT JOIN clarity.dbo.clarity_ser serrefer ON serrefer.PROV_ID = op.REFERRING_PROV_ID
        LEFT JOIN clarity.dbo.clarity_ser serperform ON serperform.PROV_ID = op.PROC_PERF_PROV_ID
        LEFT JOIN clarity.dbo.patient AS p          
        ON p.pat_id=op.PAT_ID
WHERE   context_name = 'ORDER'
        --AND CUR_VALUE_SOURCE = 'SmartForm 11227804'
       --AND ELEMENT_ID IN ( 'EPIC#12678','EPIC#19699') --including 
        --EPIC#19699 cervical,thoracic,lumbar   EPIC#12678 - block type: epidural, intrathecal, caudal
        --AND p.PAT_MRN_ID='MR86772'
        --AND ELEMENT_ID IN ( 'YNHHS#019', 'EPIC#2818', 'YNHHS#020', 'YNHHS#021' )
--AND op.ORDER_TIME>='6/1/2015'
--        AND op.ORDER_PROC_ID = 1
--AND SMRTDTA_ELEM_VALUE LIKE '%taps%'

